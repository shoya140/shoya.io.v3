<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <meta name="description" content="Shoya Ishimaru (shoya140)'s weblog about his input/output.">
    <meta name="author" href="https://plus.google.com/u/0/102413339779614193497/posts">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="google-site-verification" content="sFx-iJWT2iihts7-5wK7CnR03-MymfWXmn_7KNoyIz0" />
    <meta property="og:title" content="shoya.io">
    <meta property="og:type" content="article">
    <meta property="og:url" content="http://shoya.io/page16/index.html">
    
        <meta property="og:image" content="http://shoya.io/assets/img/icon_laptop.png">
    
    <title>shoya.io</title>

    <link rel="alternate" type="application/rss+xml" title="shoya.io" href="http://shoya.io/feed.xml">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://shoya.io/page16/">
    <link rel="shortcut icon" href="http://shoya.io/assets/img/favicon.ico">

    <script type="text/javascript" src="/assets/js/jquery.1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.color.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/assets/js/star.js"></script>
    <script type="text/javascript">Hatena.Star.Token = 'd2f3ada92845cdc5beeb7325518464d39adf9e88';</script>
    <script src="/assets/js/main.js"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a href="/"><img class="logo" src="/assets/img/logo.png"></a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/blog/">Blog</a>
          <a class="page-link" href="/research/">Research</a>
          <a class="page-link" href="/development/">Development</a>
          <a class="page-link" href="/aboutme/">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="wrapper-inside">
          
<div class="post">
  <header class="post-header">
    <p class="post-meta">Dec 14, 2013
    
    [<a href="/tag/Programming/">Programming</a>]
    
    </p>
    <a href="/blog/mongodb_json/"><h1 class="post-title">MongoDBのObjectID型をJSONに変換する[pymongo]</h1></a>
  </header>
  <article class="post-content">
    <p>MongoDBから条件に合うオブジェクトを取り出して, エンコードされたJSONを返すapiを作成しようとしたところ, つまずいたのでメモ.</p>

<h3 id="section">問題</h3>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># DB接続確立</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">27017</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="s">&quot;restaurant&quot;</span><span class="p">]</span>

<span class="c"># 取り出しとエンコード</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;date&quot;</span><span class="p">:</span><span class="s">&quot;13.12.2013&quot;</span><span class="p">})</span>
<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></code></pre></div>

<p>実行結果:エラー</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="ne">TypeError</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;52aa539a86d00a0fac59fb10&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">JSON</span> <span class="n">serializable</span></code></pre></div>

<p>MongoDBから得られたオブジェクトをjsonモジュールのdumpus関数に直接渡すとエラーが生じる.
この問題は, PythonのJSONモジュールがMongoDBの特殊なObjectID型をJSONに変換する方法を知らないことによる.</p>

<h3 id="section-1">解決策</h3>

<p>JSONエンコードする前にディクショナリから_idキーを削除する.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># 取り出しとエンコード</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">restaurant</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;date&quot;</span><span class="p">:</span><span class="s">&quot;13.12.2013&quot;</span><span class="p">})</span>
<span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="s">&quot;_id&quot;</span><span class="p">]</span>
<span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></code></pre></div>

<p>実行結果:正しくエンコードされる.</p>

<h3 id="section-2">参考文献</h3>

<p><a href="http://www.oreilly.co.jp/books/9784873115764/">O’Reilly Japan - 概説Tornado</a> MongoDBドキュメントとJSON</p>

  </article>
  <div class="post-social">
    <div class="tweet-button"><a href="https://twitter.com/share?text=MongoDB%E3%81%AEObjectID%E5%9E%8B%E3%82%92JSON%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B[pymongo]%20-%20shoya.io&amp;url=http://shoya.io/blog/mongodb_json/"><span class="lsf" style="font-size:20px;">twitter</span> tweet
  </a></div>
    <div class="facebook-button"><a href="http://www.facebook.com/sharer.php?u=http://shoya.io/blog/mongodb_json/&amp;t=MongoDB%E3%81%AEObjectID%E5%9E%8B%E3%82%92JSON%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B[pymongo]" onClick="window.open(encodeURI(decodeURI(this.href)), 'sharewindow', 'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'); return false;"><span class="lsf" style="font-size:20px;">facebook</span> share
  </a></div>
    <div class="hatenabookmark-button"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=http://shoya.io/blog/mongodb_json/"><span class="lsf" style="font-size:20px;">hatenabookmark</span> bookmark
  </a></div>
    <div class="hatena-star"><a href="http://shoya.io/blog/mongodb_json/" style="display: none;">hatena</a></div>
  </div>
</div>
<hr>

<div class="post">
  <header class="post-header">
    <p class="post-meta">Dec 3, 2013
    
    [<a href="/tag/Sightseeing/">Sightseeing</a>]
    
    </p>
    <a href="/blog/frankfurt/"><h1 class="post-title">産業の中心地フランクフルト</h1></a>
  </header>
  <article class="post-content">
    <p>産業の中心地であり国際空港をもつ交通の要衝でもあるフランクフルトを観光しました。</p>

<p class="injection-center">旧オペラ座</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt01.JPG" class="image-on-frame" /></p>

<p class="injection-center">大聖堂</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt02.JPG" class="image-on-frame-small" /></p>

<p>大聖堂の近くの広場ではクリスマスマーケットが開催されていました。</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt03.JPG" class="image-on-frame" /></p>

<p>グリューワインがとっても美味しかった。</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt04.JPG" class="image-on-frame" /></p>

<p>一緒にワインを飲んでいたおじいさんに、グリューワインの楽しみ方を教えてもらいました。このマグカップはお店に返すことでデポジットを受け取ってもいいし、お土産として持って帰ってもいいとのこと。マグカップのデザインはその年その場所によって異なるので、ドイツ各地のマグカップをコレクションする人もいるようです。</p>

<p>この辺りに美術館や博物館はありませんかと聞いたところ、おすすめを紹介してくれました。</p>

<p class="injection-center">モダンアート美術館</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt05.JPG" class="image-on-frame" /></p>

<p>月曜は休館日。</p>

<p class="injection-center">シュテーデル美術館</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt06.JPG" class="image-on-frame" /></p>

<p>月曜は休館日。</p>

<p class="injection-center">ゼンケンベルグ自然博物館</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt07.JPG" class="image-on-frame" /></p>

<p>月曜も開いてた！</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt08.JPG" class="image-on-frame" /></p>

<p>どうぶつの森の博物館みたい。</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt09.JPG" class="image-on-frame" /></p>

<p>曲線が美しすぎる。</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt10.JPG" class="image-on-frame" /></p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt11.JPG" class="image-on-frame" /></p>

<p>膨大な数の化石や剥製が展示されていて、自然科学好きにはたまらないと思う。アメリカバイソンの大きさに一番衝撃を受けた。別館では地球の誕生に関する特別展示が開催されていて、これもまた面白かった。</p>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/frankfurt12.JPG" class="image-on-frame" /></p>

<p>地下鉄があり移動しやすく、一日で観光できる良い所でした。</p>

  </article>
  <div class="post-social">
    <div class="tweet-button"><a href="https://twitter.com/share?text=%E7%94%A3%E6%A5%AD%E3%81%AE%E4%B8%AD%E5%BF%83%E5%9C%B0%E3%83%95%E3%83%A9%E3%83%B3%E3%82%AF%E3%83%95%E3%83%AB%E3%83%88%20-%20shoya.io&amp;url=http://shoya.io/blog/frankfurt/"><span class="lsf" style="font-size:20px;">twitter</span> tweet
  </a></div>
    <div class="facebook-button"><a href="http://www.facebook.com/sharer.php?u=http://shoya.io/blog/frankfurt/&amp;t=%E7%94%A3%E6%A5%AD%E3%81%AE%E4%B8%AD%E5%BF%83%E5%9C%B0%E3%83%95%E3%83%A9%E3%83%B3%E3%82%AF%E3%83%95%E3%83%AB%E3%83%88" onClick="window.open(encodeURI(decodeURI(this.href)), 'sharewindow', 'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'); return false;"><span class="lsf" style="font-size:20px;">facebook</span> share
  </a></div>
    <div class="hatenabookmark-button"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=http://shoya.io/blog/frankfurt/"><span class="lsf" style="font-size:20px;">hatenabookmark</span> bookmark
  </a></div>
    <div class="hatena-star"><a href="http://shoya.io/blog/frankfurt/" style="display: none;">hatena</a></div>
  </div>
</div>
<hr>

<div class="post">
  <header class="post-header">
    <p class="post-meta">Nov 25, 2013
    
    [<a href="/tag/Infrastructure/">Infrastructure</a>]
    
    </p>
    <a href="/blog/gitlab_installation/"><h1 class="post-title">GitLab 6.0をインストールする</h1></a>
  </header>
  <article class="post-content">
    <p><a href="http://gitlab.org/">GitLab</a>とはGitHubクローンのひとつで、ソースコードの管理やコードレビュー、複数人でのプロジェクト開発を円滑にするツールです。<a href="https://github.com/">GitHub</a>との違いは、無料でプライベート(非公開の)リポジトリをいくつでも作ることができる点と、社外・学外のサーバーに機密情報を含むデータを預ける必要がない点にあります。(GitHub Enterpriseとの比較は割愛)</p>

<p>今回は大学の計算機にGit/GitLab環境を構築したので、その手順メモを記しました。<a href="https://github.com/gitlabhq/gitlabhq/blob/6-0-stable/doc/install/installation.md">インストールガイド</a>を参考に、redisの起動など足りないところを補完してあります。<br />GitLabのインストール方法はバージョンによって少しずつ異なります。6.1, 6.2はsidekiqの立ち上げに問題があるので、2013年11月現在は6.0を導入するのが最善かと思われます。</p>

<h2 id="span-classlsfsetupspan-"><span class="lsf">setup</span> 環境</h2>
<ul>
  <li>Debian 6.0.8</li>
  <li>GitLab 6.0</li>
  <li>git 1.8.4</li>
  <li>python 2.6.6</li>
  <li>ruby 2.0.0</li>
  <li>redis 2.6.10</li>
  <li>mysql 14.14</li>
  <li>nginx 0.7.67</li>
</ul>

<h2 id="section">1. 導入準備 (必要に応じて)</h2>
<p>GitLabを導入する前に、sudoコマンド、エディタ(Vim)、Git、Python、Ruby、MySQLをインストールします。既にインストールしている場合は<strong>手順2</strong>まで読み飛ばしてください。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># run as root!</span>
apt-get update -y
apt-get upgrade -y
apt-get install sudo -y</code></pre></div>

<h2 id="vim">1.1. Vimインストール</h2>

<p>Vimをインストールして、標準のエディタとして設定。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install Vim</span>
sudo apt-get install -y vim
sudo update-alternatives --set editor /usr/bin/vim.basic</code></pre></div>

<h2 id="git">1.2. Gitインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install git</span>
sudo apt-get install -y git-core

<span class="c"># Make sure Git is version 1.7.10 or higher, for example 1.7.12 or 1.8.4</span>
git --version</code></pre></div>

<p>Gitのバージョンが1.7.10より小さい場合は以下の手順でアップデート</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Remove packaged Git</span>
sudo apt-get remove git-core

<span class="c"># Install dependencies</span>
sudo apt-get install -y libcurl4-openssl-dev libexpat1-dev gettext libz-dev libssl-dev build-essential

<span class="c"># Download and compile from source</span>
<span class="nb">cd</span> /tmp
curl --progress https://git-core.googlecode.com/files/git-1.8.4.1.tar.gz <span class="p">|</span> tar xz
<span class="nb">cd </span>git-1.8.4.1/
make <span class="nv">prefix</span><span class="o">=</span>/usr/local all

<span class="c"># Install into /usr/local/bin</span>
sudo make <span class="nv">prefix</span><span class="o">=</span>/usr/local install</code></pre></div>

<p>※Gitを/usr/local/bin/gitにインストールしたので、<strong>手順8</strong>でconfig/gitlab.ymlを編集するときにbin_pathを/usr/local/bin/gitに書き換えること。</p>

<h2 id="python">1.3. Pythonインストール</h2>

<p>“python2”でpython2.xが起動するように設定する。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install python</span>
sudo apt-get install -y python

<span class="c"># Make sure that Python is 2.5+ (3.x is not supported at the moment)</span>
python --version

<span class="c"># If it&#39;s Python 3 you might need to install Python 2 separately</span>
sudo apt-get install -y python2.7

<span class="c"># Make sure you can access Python via python2</span>
python2 --version

<span class="c"># If you get a &quot;command not found&quot; error create a link to the python binary</span>
sudo ln -s /usr/bin/python /usr/bin/python2

<span class="c"># For reStructuredText markup language support install required package:</span>
sudo apt-get install -y python-docutils</code></pre></div>

<h2 id="ruby-">1.4. Ruby インストール</h2>

<p>システムデフォルトのRubyは1.9.3より古い可能性大なのでアップデート。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Remove the old Ruby 1.8 if present</span>
sudo apt-get remove ruby1.8

<span class="c"># Download and compile from source</span>
mkdir /tmp/ruby <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/ruby
curl --progress ftp://ftp.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p353.tar.gz <span class="p">|</span> tar xz
<span class="nb">cd </span>ruby-2.0.0-p353
./configure --disable-install-rdoc

<span class="c"># Install ruby</span>
make
sudo make install</code></pre></div>

<p>Bandlerインストール</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo gem install bundler --no-ri --no-rdoc</code></pre></div>

<h2 id="mysql">1.5 MySQLインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install the database packages</span>
sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev

<span class="c"># Secure your installation.</span>
sudo mysql_secure_installation</code></pre></div>

<p>GitLab用にユーザとデータベースを作成</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Login to MySQL</span>
mysql -u root -p

<span class="c"># do not type the &#39;mysql&gt;&#39;, this is part of the prompt</span>
<span class="c"># change $password in the command below to a real password you pick</span>
mysql&gt; CREATE USER <span class="s1">&#39;gitlab&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;$password&#39;</span><span class="p">;</span>

<span class="c"># Create the GitLab production database</span>
mysql&gt; CREATE DATABASE IF NOT EXISTS <span class="sb">`</span>gitlabhq_production<span class="sb">`</span> DEFAULT CHARACTER SET <span class="sb">`</span>utf8<span class="sb">`</span> COLLATE <span class="sb">`</span>utf8_unicode_ci<span class="sb">`</span><span class="p">;</span>

<span class="c"># Grant the GitLab user necessary permissions on the table.</span>
mysql&gt; GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON <span class="sb">`</span>gitlabhq_production<span class="sb">`</span>.* TO <span class="s1">&#39;gitlab&#39;</span>@<span class="s1">&#39;localhost&#39;</span><span class="p">;</span>

<span class="c"># Quit the database session</span>
mysql&gt; <span class="se">\q</span></code></pre></div>

<h2 id="git-1">2. Gitユーザの作成</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo adduser --disabled-login --gecos <span class="s1">&#39;GitLab&#39;</span> git</code></pre></div>

<p>以降の手順はGitユーザで行います。</p>

<h2 id="section-1">3. 必要パッケージのインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server redis-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate</code></pre></div>

<h2 id="gitlab-shell">4. GitLab shellインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /home/git

<span class="c"># Clone gitlab shell</span>
sudo -u git -H git clone https://github.com/gitlabhq/gitlab-shell.git

<span class="c"># Go to gitlab-shell dir</span>
<span class="nb">cd </span>gitlab-shell

<span class="c"># switch to right version</span>
sudo -u git -H git checkout v1.7.0</code></pre></div>

<p>config.yml.exampleをもとにconfig.ymlを作成して、http://localhost/のところをGitLabをセットアップするURL(例: http://YOUR_DOMAIN.COM)に書き換える。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Copy config.yml from config.yml.example</span>
sudo -u git -H cp config.yml.example config.yml

<span class="c"># Edit config and replace gitlab_url</span>
<span class="c"># with something like &#39;http://YOUR_DOMAIN.COM/&#39;</span>
sudo -u git -H editor config.yml</code></pre></div>

<p>hostsのlocalhostにYOUR_DMAIN.COMを追記する。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Edit hosts</span>
sudo vim /etc/hosts

<span class="c"># Add a new hosts setting like this</span>
127.0.0.1    YOUR_DOMAIN.COM</code></pre></div>

<p>インストール</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo -u git -H ./bin/install</code></pre></div>

<h2 id="gitlab">5. GitLabインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /home/git

<span class="c"># Clone GitLab repository</span>
sudo -u git -H git clone https://github.com/gitlabhq/gitlabhq.git gitlab

<span class="c"># Go to gitlab dir</span>
<span class="nb">cd</span> /home/git/gitlab

<span class="c"># Checkout to stable release</span>
sudo -u git -H git checkout 6-0-stable

<span class="c"># Make sure GitLab can write to the log/ and tmp/ directories</span>
sudo chown -R git log/
sudo chown -R git tmp/
sudo chmod -R u+rwX log/
sudo chmod -R u+rwX tmp/

<span class="c"># Create directory for satellites</span>
sudo -u git -H mkdir /home/git/gitlab-satellites

<span class="c"># Create directories for sockets/pids and make sure GitLab can write to them</span>
sudo -u git -H mkdir tmp/pids/
sudo -u git -H mkdir tmp/sockets/
sudo chmod -R u+rwX  tmp/pids/
sudo chmod -R u+rwX  tmp/sockets/

<span class="c"># Create public/uploads directory otherwise backup will fail</span>
sudo -u git -H mkdir public/uploads
sudo chmod -R u+rwX  public/uploads

<span class="c"># Configure Git global settings for git user, useful when editing via web</span>
<span class="c"># Edit user.email according to what is set in gitlab.yml</span>
sudo -u git -H git config --global user.name <span class="s2">&quot;GitLab&quot;</span>
sudo -u git -H git config --global user.email <span class="s2">&quot;gitlab@localhost&quot;</span>
sudo -u git -H git config --global core.autocrlf input</code></pre></div>

<p>config/gitlab.yml.exampleをもとにconfig/gitlab.ymlを作成して、localhostのところをGitLabをセットアップするURLに編集する。gitのインストール先をusr/local/bin/gitに変更した場合はgit bin_pathも書き換える。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Copy the example GitLab config</span>
sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml

<span class="c"># Make sure to change &quot;localhost&quot; to the fully-qualified domain name of your</span>
<span class="c"># host serving GitLab where necessary</span>
sudo -u git -H editor config/gitlab.yml</code></pre></div>

<p>config/unicorn.rb.example config/unicorn.rbを作成して編集する。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Copy the example Unicorn config</span>
sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb

<span class="c"># Enable cluster mode if you expect to have a high load instance</span>
<span class="c"># Ex. change amount of workers to 3 for 2GB RAM server</span>
sudo -u git -H editor config/unicorn.rb</code></pre></div>

<h2 id="mysql-1">6. MySQLとの接続確認</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Mysql</span>
sudo -u git cp config/database.yml.mysql config/database.yml

<span class="c"># Make sure to update username/password in config/database.yml.</span>
<span class="c"># You only need to adapt the production settings (first part).</span>
<span class="c"># If you followed the database guide then please do as follows:</span>
<span class="c"># Change &#39;secure password&#39; with the value you have given to $password</span>
<span class="c"># You can keep the double quotes around the password</span>
sudo -u git -H editor config/database.yml

<span class="c"># Make config/database.yml readable to git only</span>
sudo -u git -H chmod o-rwx config/database.yml</code></pre></div>

<h2 id="gem">7. Gemインストール</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /home/git/gitlab

sudo -u git -H bundle install --deployment --without development <span class="nb">test </span>postgres aws</code></pre></div>

<h2 id="section-2">8. データベース初期化</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Type &#39;yes&#39; to create the database.</span>
sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>production</code></pre></div>

<h2 id="section-3">9. 起動ファイル導入</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo rm /etc/init.d/gitlab
sudo curl --output /etc/init.d/gitlab https://raw.github.com/gitlabhq/gitlabhq/6-0-stable/lib/support/init.d/gitlab
sudo chmod +x /etc/init.d/gitlab</code></pre></div>

<p>サーバー起動時にGitLabが自動起動するよう設定</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo update-rc.d gitlab defaults 21</code></pre></div>

<h2 id="redis">10. Redis起動</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo /etc/init.d/redis-server start</code></pre></div>

<h2 id="gitlab-1">11. GitLabの起動</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">/etc/init.d/gitlab start</code></pre></div>

<p>停止と再起動は下記の通り。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">/etc/init.d/gitlab stop
/etc/init.d/gitlab restart</code></pre></div>

<h2 id="nginx">12. Nginx(リバースプロキシ)の設定</h2>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install nginx</span>
sudo apt-get install -y nginx</code></pre></div>

<p>gitlab用設定ファイルの導入</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab
sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab

<span class="c"># Change YOUR_SERVER_FQDN to the fully-qualified</span>
<span class="c"># domain name of your host serving GitLab.</span>
sudo editor /etc/nginx/sites-available/gitlab</code></pre></div>

<p>Nginx再起動</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo /etc/init.d/nginx restart</code></pre></div>

<p><img src="https://dl.dropboxusercontent.com/u/12208857/img/gitlab_ss.png" class="image-on-frame image-center" /></p>

<p>以上の設定でhttp://YOUR_DOMAIN.COM/でGitLabへアクセスできます。
管理者アカウントの初期設定は下記のとおりです。</p>
<pre>
User: admin@local.host
Pass: 5iveL!fe
</pre>

<h2 id="section-4">トラブルシューティング</h2>

<h3 id="span-classlsfcheckspan-httpsgit-clone"><span class="lsf">check</span> httpsプロトコルでgit cloneできない</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git config –global http.sslVerify <span class="nb">false</span></code></pre></div>

<p>を実行して、証明書チェックを外す。<br />
参考：<a href="http://319ring.net/blog/archives/1164">GIT:リポジトリにHTTPSでアクセスしてみる - 自転車で通勤しましょ♪ブログ</a></p>

<h3 id="span-classlsfcheckspan-cant-save-project-please-try-again-later"><span class="lsf">check</span> Can’t save project. Please try again later</h3>

<p>redis-serverをアップデートする</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&quot;deb http://backports.debian.org/debian-backports squeeze-backports main&quot;</span> &gt;&gt; /etc/apt/sources.list
apt-get update
apt-get -t squeeze-backports install redis-server</code></pre></div>

<p>参考：<a href="https://github.com/gitlabhq/gitlabhq/issues/3328">“Can’t save project. Please try again later” - GitHub issues</a></p>

<h3 id="span-classlsfcheckspan-502-bad-gateway-"><span class="lsf">check</span> 502 Bad Gateway ページが見つからない</h3>

<p>タイムアウト値を30から180くらいに変更する</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo -u git -H editor config/unicorn.rb</code></pre></div>

<p>参考：<a href="http://stackoverflow.com/questions/18501406/502-bad-gateway-from-nginx-for-large-gitlab-fork">502 Bad Gateway from Nginx for large GitLab fork - stackoverflow</a></p>

<h3 id="span-classlsfcheckspan-gitlab-shell-self-check-failed"><span class="lsf">check</span> gitlab-shell self-check failed</h3>

<p>virtual hostsの設定を取りこぼしてないか確認する</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Edit hosts</span>
sudo vim /etc/hosts

<span class="c"># Add a new hosts setting like this</span>
127.0.0.1    YOUR_DOMAIN.COM</code></pre></div>

<h3 id="span-classlsfcheckspan-"><span class="lsf">check</span> その他の問題解決</h3>

<p>おかしいなと思ったら、以下のコマンドを実行。<br />
エラーメッセージから原因を見つけて修復する。</p>

<p><strong>・インストール情報の表示</strong></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:env:info <span class="nv">RAILS_ENV</span><span class="o">=</span>production</code></pre></div>

<p>成功例</p>
<pre>
System information
System:         Debian 6.0.8
Current User:   git
Using RVM:      yes
RVM Version:    1.24.4
Ruby Version:   2.0.0p353
Gem Version:    2.0.14
Bundler Version:1.3.5
Rake Version:   10.1.0

GitLab information
Version:        6.0.2
Revision:       10b0b8f
Directory:      /home/git/gitlab
DB Adapter:     mysql2
URL:            http://YOUR_DOMAIN.COM
HTTP Clone URL: http://YOUR_DOMAIN.COM/some-project.git
SSH Clone URL:  git@YOUR_DOMAIN.COM:some-project.git
Using LDAP:     no
Using Omniauth: no

GitLab Shell
Version:        1.7.0
Repositories:   /home/git/repositories/
Hooks:          /home/git/gitlab-shell/hooks/
Git:            /usr/bin/git
</pre>

<p><strong>・起動確認</strong></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:check <span class="nv">RAILS_ENV</span><span class="o">=</span>production</code></pre></div>

<p>成功例</p>
<pre>
Checking Environment ...

Git configured for git user? ... yes
Has python2? ... yes
python2 is supported version? ... yes

Checking Environment ... Finished

Checking GitLab Shell ...

GitLab Shell version &gt;= 1.7.9 ? ... OK (1.7.9)
Repo base directory exists? ... yes
Repo base directory is a symlink? ... no
Repo base owned by git:git? ... yes
Repo base access is drwxrws---? ... yes
update hook up-to-date? ... yes
update hooks in repos are links: ... can't check, you have no projects
Running /home/git/gitlab-shell/bin/check
Check GitLab API access: OK
Check directories and files:
        /home/git/repositories: OK
        /home/git/.ssh/authorized_keys: OK
        /usr/bin/redis-cli: OK
gitlab-shell self-check successful

Checking GitLab Shell ... Finished

Checking Sidekiq ...

Running? ... yes
Number of Sidekiq processes ... 1

Checking Sidekiq ... Finished

Checking GitLab ...

Database config exists? ... yes
Database is SQLite ... no
All migrations up? ... yes
GitLab config exists? ... yes
GitLab config outdated? ... no
Log directory writable? ... yes
Tmp directory writable? ... yes
Init script exists? ... yes
Init script up-to-date? ... yes
projects have namespace: ... can't check, you have no projects
Projects have satellites? ... can't check, you have no projects
Redis version &gt;= 2.0.0? ... yes
Your git bin path is "/usr/bin/git"
Git version &gt;= 1.7.10 ? ... yes (1.8.3)

Checking GitLab ... Finished

</pre>

<p>6.2で転けて、6.1で転けて、ここまで設定するのに3日かかった…</p>

  </article>
  <div class="post-social">
    <div class="tweet-button"><a href="https://twitter.com/share?text=GitLab%206.0%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%20-%20shoya.io&amp;url=http://shoya.io/blog/gitlab_installation/"><span class="lsf" style="font-size:20px;">twitter</span> tweet
  </a></div>
    <div class="facebook-button"><a href="http://www.facebook.com/sharer.php?u=http://shoya.io/blog/gitlab_installation/&amp;t=GitLab%206.0%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B" onClick="window.open(encodeURI(decodeURI(this.href)), 'sharewindow', 'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'); return false;"><span class="lsf" style="font-size:20px;">facebook</span> share
  </a></div>
    <div class="hatenabookmark-button"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=http://shoya.io/blog/gitlab_installation/"><span class="lsf" style="font-size:20px;">hatenabookmark</span> bookmark
  </a></div>
    <div class="hatena-star"><a href="http://shoya.io/blog/gitlab_installation/" style="display: none;">hatena</a></div>
  </div>
</div>
<hr>


<div class="pagenation">
    
        <div class="page-button"><a href="/page17"></a><span class="lsf">left</span> Previous</div>
    
    
        
            <div class="page-button"><a href="/page15"></a>Next <span class="lsf">right</span></div>
        
    
</div>
        </div>
      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper-footer">
    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-3">
        <p><span class="lsf">crown</span> 人気の記事</p>
        <ul>
        
          <li>- <a href="/blog/Paletta/" class="linkedTitle">Now loading..</a></li>
        
          <li>- <a href="/blog/cookpad_internship/" class="linkedTitle">Now loading..</a></li>
        
          <li>- <a href="/blog/hatena_intern/" class="linkedTitle">Now loading..</a></li>
        
          <li>- <a href="/blog/towards-a-scientist/" class="linkedTitle">Now loading..</a></li>
        
          <li>- <a href="/blog/internet_black_market/" class="linkedTitle">Now loading..</a></li>
        
          <li>- <a href="/blog/long_shadow/" class="linkedTitle">Now loading..</a></li>
        
        </ul>
      </div>
      <div class="footer-col  footer-col-3">
        <p><span class="lsf">list</span> 最近の記事</p>
        <ul>
        
          <li>- <a href="/blog/bootcamp_hyperv/">BootcampでWindows8.1を起動する際にHyper-Vが実行されない問題を解決する</a></li>
        
          <li>- <a href="/blog/recruit_internship/">リクルートホールディングスのインターンシップに参加しました</a></li>
        
          <li>- <a href="/blog/bighero6/">「ベイマックス」観た</a></li>
        
          <li>- <a href="/blog/brain-science-for-the-mind/">「心の脳科学」読んだ</a></li>
        
          <li>- <a href="/blog/pypi/">Pythonライブラリを作成してPyPIに登録する</a></li>
        
          <li>- <a href="/blog/looking-back-at-2014/">2014年振り返り</a></li>
        
        </ul>
      </div>
      <div class="footer-col  footer-col-1">
        <p><span class="lsf">tag</span> 記事のタグ</p>
        
        [<a href="/tag/Event/">Event</a>]
        
        [<a href="/tag/Note/">Note</a>]
        
        [<a href="/tag/ReleaseNote/">ReleaseNote</a>]
        
        [<a href="/tag/Sightseeing/">Sightseeing</a>]
        
        [<a href="/tag/Programming/">Programming</a>]
        
        [<a href="/tag/Infrastructure/">Infrastructure</a>]
        
        [<a href="/tag/Design/">Design</a>]
        
      </div>
    </div>
    <div class="footer-bio">
      <a href = "https://github.com/shoya140/"><img src="/assets/img/icon_github.png" class="footer-icon"></a>
      <a href = "https://twitter.com/shoya140/"><img src="/assets/img/icon_twitter.png" class="footer-icon"></a>
      <script type="text/javascript" language="javascript">
      function mail(){var s="FI=;NCIHeBL?@tYG;CFNIqMBIS;eCMBCG;LOwAG;CFe=IGY",r="";
      for(i=0;i<s.length;i++)r+=String.fromCharCode((s.charCodeAt(i)+5)%93+33);eval(r);}
        document.write('<a href="javascript:mail()"><img src="/assets/img/icon_mail.png" class="footer-icon"></a>')</script>
      <a href = "http://mrk1869.com/feed.xml"><img src="/assets/img/icon_rss.png" class="footer-icon"></a><br>
      <p>© 2014 <a href="https://plus.google.com/102413339779614193497?rel=author">Shoya Ishimaru</a></p>
    </div>
  </div>
</footer>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1918944-8']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  </body>

</html>
